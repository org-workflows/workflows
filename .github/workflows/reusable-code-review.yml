# =============================================================================
# Reusable AI Code Review Pipeline
# Claude + OpenAIë¥¼ ì‚¬ìš©í•œ ì´ì¤‘ AI ì½”ë“œ ë¦¬ë·°
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     review:
#       uses: ldmrepo/org-workflows/.github/workflows/reusable-code-review.yml@v1
#       secrets:
#         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#
# =============================================================================

name: Reusable AI Code Review

on:
  workflow_call:
    inputs:
      run-security-review:
        description: 'Claude ë³´ì•ˆ ë¦¬ë·° ì‹¤í–‰'
        type: boolean
        required: false
        default: true

      run-quality-review:
        description: 'OpenAI í’ˆì§ˆ ë¦¬ë·° ì‹¤í–‰'
        type: boolean
        required: false
        default: true

      notify-slack:
        description: 'Slack ì•Œë¦¼ ì—¬ë¶€'
        type: boolean
        required: false
        default: true

    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API Key (Claude)'
        required: true

      OPENAI_API_KEY:
        description: 'OpenAI API Key'
        required: false

      SLACK_WEBHOOK:
        description: 'Slack ì›¹í›… URL'
        required: false

jobs:
  security-review:
    name: Security Review (Claude)
    if: ${{ inputs.run-security-review }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "files=$(gh pr diff ${{ github.event.number }} --name-only | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Security Review with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(gh pr comment *),Write"
          prompt: |
            PR #${{ github.event.number }} ë³´ì•ˆ ê²€í† 

            ë³€ê²½ëœ íŒŒì¼: ${{ steps.changed-files.outputs.files }}

            ## ê²€í†  í•­ëª©
            - SQL Injection ì·¨ì•½ì 
            - XSS (Cross-Site Scripting)
            - í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿/API í‚¤
            - ë¯¼ê°ì •ë³´ ë¡œê¹…
            - ì¸ì¦/ì¸ê°€ ìš°íšŒ ê°€ëŠ¥ì„±

            ## ì¶œë ¥
            /tmp/security-review.mdì— ê²°ê³¼ ì €ì¥:
            - ğŸ”´ Critical / ğŸŸ  Warning / ğŸŸ¡ Info
            - ë§ˆì§€ë§‰ì— 'ğŸ”’ *Claude Security Review*' ì„œëª…

      - name: Post Security Review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f /tmp/security-review.md ]; then
            gh pr comment ${{ github.event.number }} --body-file /tmp/security-review.md
          fi

  quality-review:
    name: Quality Review (OpenAI)
    if: ${{ inputs.run-quality-review && secrets.OPENAI_API_KEY != '' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ github.event.number }} | head -c 15000 > /tmp/pr-diff.txt

      - name: Quality Review with OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat /tmp/pr-diff.txt)

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg diff "$DIFF_CONTENT" \
              --arg pr "${{ github.event.number }}" \
              --arg title "${{ github.event.pull_request.title }}" \
              '{
                model: "gpt-4o",
                messages: [{
                  role: "system",
                  content: "ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
                }, {
                  role: "user",
                  content: ("PR #" + $pr + ": " + $title + "\n\n```diff\n" + $diff + "\n```\n\nì½”ë“œ í’ˆì§ˆ ì ìˆ˜(A-F)ì™€ ê°œì„ ì‚¬í•­ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.\n\në§ˆì§€ë§‰ì— ğŸ¤– *OpenAI GPT-4o Code Review* ì„œëª… ì¶”ê°€")
                }],
                temperature: 0.3,
                max_tokens: 2000
              }')")

          echo "$RESPONSE" | jq -r '.choices[0].message.content // "ë¶„ì„ ì‹¤íŒ¨"' > /tmp/quality-review.md

      - name: Post Quality Review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f /tmp/quality-review.md ] && [ -s /tmp/quality-review.md ]; then
            gh pr comment ${{ github.event.number }} --body-file /tmp/quality-review.md
          fi

  summary:
    name: Review Summary
    needs: [security-review, quality-review]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Post Summary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SECURITY="${{ needs.security-review.result }}"
          QUALITY="${{ needs.quality-review.result }}"

          gh pr comment ${{ github.event.number }} --body "## ğŸ” AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ

          | AI | ë‹´ë‹¹ ì˜ì—­ | ìƒíƒœ |
          |-----|----------|------|
          | ğŸ”’ Claude | ë³´ì•ˆ ê²€í†  | $( [ \"$SECURITY\" = \"success\" ] && echo \"âœ… ì™„ë£Œ\" || echo \"â­ï¸ ìŠ¤í‚µ\" ) |
          | ğŸ“Š OpenAI | ì½”ë“œ í’ˆì§ˆ | $( [ \"$QUALITY\" = \"success\" ] && echo \"âœ… ì™„ë£Œ\" || echo \"â­ï¸ ìŠ¤í‚µ\" ) |

          ---
          âš ï¸ **AI ë¦¬ë·°ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ìµœì¢… ìŠ¹ì¸ì€ ë°˜ë“œì‹œ íŒ€ì›ì´ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.**"

      - name: Notify Slack
        if: ${{ inputs.notify-slack && secrets.SLACK_WEBHOOK != '' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ğŸ” AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ: PR #${{ github.event.number }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ğŸ” AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ*\nâ€¢ PR: #${{ github.event.number }}\nâ€¢ <${{ github.event.pull_request.html_url }}|PR ë³´ê¸°>\"
                  }
                }
              ]
            }"
