# =============================================================================
# Reusable Deploy Pipeline
# ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ë°°í¬ íŒŒì´í”„ë¼ì¸
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     deploy:
#       uses: org-workflows/workflows/.github/workflows/reusable-deploy.yml@v1
#       with:
#         environment: staging
#         url: https://staging.example.com
#       secrets: inherit
#
# =============================================================================

name: ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  workflow_call:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ (staging, production)'
        type: string
        required: true

      url:
        description: 'ë°°í¬ ëŒ€ìƒ URL'
        type: string
        required: false
        default: ''

      node-version:
        description: 'Node.js ë²„ì „'
        type: string
        required: false
        default: '20'

      working-directory:
        description: 'ì‘ì—… ë””ë ‰í† ë¦¬'
        type: string
        required: false
        default: '.'

      artifact-name:
        description: 'ë‹¤ìš´ë¡œë“œí•  ì•„í‹°íŒ©íŠ¸ ì´ë¦„'
        type: string
        required: false
        default: ''

      run-health-check:
        description: 'í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì—¬ë¶€'
        type: boolean
        required: false
        default: true

      health-check-path:
        description: 'í—¬ìŠ¤ì²´í¬ ê²½ë¡œ'
        type: string
        required: false
        default: '/health'

      health-check-retries:
        description: 'í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ íšŸìˆ˜'
        type: number
        required: false
        default: 5

      notify-slack:
        description: 'Slack ì•Œë¦¼ ì—¬ë¶€'
        type: boolean
        required: false
        default: true

    secrets:
      DEPLOY_TOKEN:
        description: 'ë°°í¬ í† í°'
        required: false

      SLACK_WEBHOOK:
        description: 'Slack ì›¹í›… URL'
        required: false

    outputs:
      deploy-url:
        description: 'ë°°í¬ëœ URL'
        value: ${{ jobs.deploy.outputs.url }}

      deploy-status:
        description: 'ë°°í¬ ìƒíƒœ'
        value: ${{ jobs.deploy.outputs.status }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.url }}
    outputs:
      url: ${{ inputs.url }}
      status: ${{ steps.deploy.outcome }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifact
        if: ${{ inputs.artifact-name != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory }}/dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Pre-deployment Info
        run: |
          echo "ğŸš€ Deploying to ${{ inputs.environment }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ”– Ref: ${{ github.ref }}"
          echo "ğŸ“ SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"

      - name: Deploy
        id: deploy
        working-directory: ${{ inputs.working-directory }}
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Starting deployment..."

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìœ¼ë©´ ì‹¤í–‰
          if [ -f "./scripts/deploy.sh" ]; then
            chmod +x ./scripts/deploy.sh
            ./scripts/deploy.sh
          elif [ -f "./scripts/deploy-${{ inputs.environment }}.sh" ]; then
            chmod +x ./scripts/deploy-${{ inputs.environment }}.sh
            ./scripts/deploy-${{ inputs.environment }}.sh
          else
            echo "âš ï¸ No deploy script found, skipping deployment step"
            echo "   Expected: ./scripts/deploy.sh or ./scripts/deploy-${{ inputs.environment }}.sh"
          fi

          echo "âœ… Deployment step completed"

      - name: Wait for Deployment
        if: ${{ inputs.run-health-check && inputs.url != '' }}
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30

      - name: Health Check
        id: health-check
        if: ${{ inputs.run-health-check && inputs.url != '' }}
        run: |
          echo "ğŸ¥ Running health check..."
          URL="${{ inputs.url }}${{ inputs.health-check-path }}"
          MAX_RETRIES=${{ inputs.health-check-retries }}
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
              exit 0
            fi

            echo "â³ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES - HTTP $HTTP_STATUS"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 10
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Notify Success
        if: ${{ success() && inputs.notify-slack && secrets.SLACK_WEBHOOK != '' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âœ… ë°°í¬ ì™„ë£Œ: ${{ inputs.environment }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*âœ… ${{ inputs.environment }} ë°°í¬ ì™„ë£Œ*\nâ€¢ ì €ì¥ì†Œ: \`${{ github.repository }}\`\nâ€¢ ì»¤ë°‹: \`${{ github.sha }}\`\nâ€¢ ë°°í¬ì: \`${{ github.actor }}\`\"
                  }
                }
              ]
            }"

      - name: Notify Failure
        if: ${{ failure() && inputs.notify-slack && secrets.SLACK_WEBHOOK != '' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âŒ ë°°í¬ ì‹¤íŒ¨: ${{ inputs.environment }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*âŒ ${{ inputs.environment }} ë°°í¬ ì‹¤íŒ¨*\nâ€¢ ì €ì¥ì†Œ: \`${{ github.repository }}\`\nâ€¢ ì»¤ë°‹: \`${{ github.sha }}\`\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>\"
                  }
                }
              ]
            }"
