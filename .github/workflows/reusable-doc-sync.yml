# =============================================================================
# Reusable Documentation Sync Workflow (OpenAI)
# API, ÌÉÄÏûÖ, ÏÑ§Ï†ï ÌååÏùº Î≥ÄÍ≤Ω Ïãú Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏ ÌïÑÏöî Ïó¨Î∂ÄÎ•º Ï≤¥ÌÅ¨Ìï©ÎãàÎã§.
# =============================================================================
#
# ÏÇ¨Ïö©Î≤ï:
#   jobs:
#     docs:
#       uses: org-workflows/workflows/.github/workflows/reusable-doc-sync.yml@v1
#       with:
#         pr-number: ${{ github.event.number }}
#       secrets:
#         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#
# =============================================================================

name: Reusable Documentation Sync

on:
  workflow_call:
    inputs:
      pr-number:
        description: 'Pull request number'
        required: true
        type: number
      model:
        description: 'OpenAI model to use'
        required: false
        type: string
        default: 'gpt-4o-mini'
      stale-days:
        description: 'Days before documentation is considered stale'
        required: false
        type: number
        default: 30
      docs-path:
        description: 'Path to documentation directory'
        required: false
        type: string
        default: 'docs'
      add-label:
        description: 'Add documentation label if docs changed'
        required: false
        type: boolean
        default: true
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key'
        required: true

jobs:
  check-docs:
    name: Check Documentation Sync
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(gh pr diff ${{ inputs.pr-number }} --name-only)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # diff ÎÇ¥Ïö©ÎèÑ Í∞ÄÏ†∏Ïò§Í∏∞ (ÌÜ†ÌÅ∞ Ï†úÌïú)
          gh pr diff ${{ inputs.pr-number }} | head -c 10000 > /tmp/pr-diff.txt

      - name: Analyze Documentation Needs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          DIFF_CONTENT=$(cat /tmp/pr-diff.txt)

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg files "$CHANGED_FILES" \
              --arg diff "$DIFF_CONTENT" \
              --arg pr_number "${{ inputs.pr-number }}" \
              --arg model "${{ inputs.model }}" \
              '{
                model: $model,
                messages: [{
                  role: "system",
                  content: "ÎãπÏã†ÏùÄ Í∏∞Ïà† Î¨∏ÏÑú Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§. ÏΩîÎìú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Î∂ÑÏÑùÌïòÏó¨ Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏ ÌïÑÏöî Ïó¨Î∂ÄÎ•º ÌåêÎã®Ìï©ÎãàÎã§."
                }, {
                  role: "user",
                  content: ("PR #" + $pr_number + " Î¨∏ÏÑú ÎèôÍ∏∞Ìôî Î∂ÑÏÑù\n\n## Î≥ÄÍ≤ΩÎêú ÌååÏùº\n" + $files + "\n\n## Î≥ÄÍ≤Ω ÎÇ¥Ïö©\n```diff\n" + $diff + "\n```\n\n## Î∂ÑÏÑù ÏöîÏ≤≠\nÎã§Ïùå Ìï≠Î™©ÏùÑ Î∂ÑÏÑùÌïòÍ≥† ÎßàÌÅ¨Îã§Ïö¥ÏúºÎ°ú Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî:\n\n1. **API Î≥ÄÍ≤Ω**: ÏÉà ÏóîÎìúÌè¨Ïù∏Ìä∏, Ïä§ÌÇ§Îßà Î≥ÄÍ≤Ω, Ïù∏Ï¶ù Î≥ÄÍ≤Ω\n2. **ÌÉÄÏûÖ Î≥ÄÍ≤Ω**: ÏÉà ÌÉÄÏûÖ, Í∏∞Ï°¥ ÌÉÄÏûÖ ÏàòÏ†ï, Breaking changes\n3. **ÏÑ§Ï†ï Î≥ÄÍ≤Ω**: ÌôòÍ≤Ω Î≥ÄÏàò, ÏÑ§Ï†ï ÏòµÏÖò\n\n## Ï∂úÎ†• ÌòïÏãù\n### üìù Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏\n\n| Î¨∏ÏÑú | ÏÉÅÌÉú | ÌïÑÏöîÌïú ÏóÖÎç∞Ïù¥Ìä∏ |\n|------|------|----------------|\n| docs/api/ | ‚úÖ/‚ö†Ô∏è/‚ûñ | ÏÑ§Î™Ö |\n| README.md | ‚úÖ/‚ö†Ô∏è/‚ûñ | ÏÑ§Î™Ö |\n| CLAUDE.md | ‚úÖ/‚ö†Ô∏è/‚ûñ | ÏÑ§Î™Ö |\n| .env.example | ‚úÖ/‚ö†Ô∏è/‚ûñ | ÏÑ§Î™Ö |\n\n### ÏÉÅÏÑ∏ ÏïàÎÇ¥\n(ÏóÖÎç∞Ïù¥Ìä∏ ÌïÑÏöîÌïú Ìï≠Î™©Ïóê ÎåÄÌïú Íµ¨Ï≤¥Ï†Å Í∞ÄÏù¥Îìú)\n\n---\nü§ñ *OpenAI Documentation Check*")
                }],
                temperature: 0.3,
                max_tokens: 1500
              }')")

          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Î¨∏ÏÑú Î∂ÑÏÑù Ïã§Ìå®"')
          echo "$ANALYSIS" > /tmp/doc-analysis.md

      - name: Check Stale Documentation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### üìÖ Î¨∏ÏÑú ÏµúÏã†ÏÑ± Í≤ÄÏÇ¨" >> /tmp/doc-analysis.md
          echo "" >> /tmp/doc-analysis.md

          # docs/ ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
          if [ -d "${{ inputs.docs-path }}" ]; then
            STALE_DOCS=""

            for doc in $(find ${{ inputs.docs-path }} -name "*.md" -type f 2>/dev/null); do
              DOC_DATE=$(git log -1 --format="%ct" -- "$doc" 2>/dev/null || echo "0")
              CURRENT_DATE=$(date +%s)
              DAYS_OLD=$(( (CURRENT_DATE - DOC_DATE) / 86400 ))

              if [ "$DAYS_OLD" -gt ${{ inputs.stale-days }} ]; then
                STALE_DOCS="$STALE_DOCS\n- ‚ö†Ô∏è \`$doc\` - ${DAYS_OLD}Ïùº Ï†Ñ ÏàòÏ†ï"
              fi
            done

            if [ -n "$STALE_DOCS" ]; then
              echo "Îã§Ïùå Î¨∏ÏÑúÎì§Ïù¥ ${{ inputs.stale-days }}Ïùº Ïù¥ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§:" >> /tmp/doc-analysis.md
              echo -e "$STALE_DOCS" >> /tmp/doc-analysis.md
            else
              echo "‚úÖ Î™®Îì† Î¨∏ÏÑúÍ∞Ä ÏµúÏã† ÏÉÅÌÉúÏûÖÎãàÎã§." >> /tmp/doc-analysis.md
            fi
          else
            echo "‚ÑπÔ∏è ${{ inputs.docs-path }}/ ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§." >> /tmp/doc-analysis.md
          fi

      - name: Post Analysis Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/doc-analysis.md ] && [ -s /tmp/doc-analysis.md ]; then
            gh pr comment ${{ inputs.pr-number }} --body-file /tmp/doc-analysis.md
          fi

      - name: Add Documentation Label
        if: inputs.add-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOC_CHANGES=$(echo "${{ steps.changed-files.outputs.files }}" | grep -E '^${{ inputs.docs-path }}/|README|\.md$' || true)

          if [ -n "$DOC_CHANGES" ]; then
            gh pr edit ${{ inputs.pr-number }} --add-label "documentation"
          fi
