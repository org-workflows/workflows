# =============================================================================
# Reusable Documentation Sync Workflow (OpenAI)
# API, íƒ€ì…, ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ë¥¼ ì²´í¬í•©ë‹ˆë‹¤.
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     docs:
#       uses: org-workflows/workflows/.github/workflows/reusable-doc-sync.yml@v1
#       with:
#         pr-number: ${{ github.event.number }}
#       secrets:
#         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#
# =============================================================================

name: ë¬¸ì„œ ë™ê¸°í™” ê²€ì‚¬

on:
  workflow_call:
    inputs:
      pr-number:
        description: 'Pull request number'
        required: true
        type: number
      model:
        description: 'OpenAI model to use'
        required: false
        type: string
        default: 'gpt-4o-mini'
      stale-days:
        description: 'Days before documentation is considered stale'
        required: false
        type: number
        default: 30
      docs-path:
        description: 'Path to documentation directory'
        required: false
        type: string
        default: 'docs'
      add-label:
        description: 'Add documentation label if docs changed'
        required: false
        type: boolean
        default: true
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key'
        required: true

jobs:
  check-docs:
    name: Check Documentation Sync
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(gh pr diff ${{ inputs.pr-number }} --name-only)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # diff ë‚´ìš©ë„ ê°€ì ¸ì˜¤ê¸° (í† í° ì œí•œ)
          gh pr diff ${{ inputs.pr-number }} | head -c 10000 > /tmp/pr-diff.txt

      - name: Analyze Documentation Needs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          DIFF_CONTENT=$(cat /tmp/pr-diff.txt)

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg files "$CHANGED_FILES" \
              --arg diff "$DIFF_CONTENT" \
              --arg pr_number "${{ inputs.pr-number }}" \
              --arg model "${{ inputs.model }}" \
              '{
                model: $model,
                messages: [{
                  role: "system",
                  content: "ë‹¹ì‹ ì€ ê¸°ìˆ  ë¬¸ì„œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤."
                }, {
                  role: "user",
                  content: ("PR #" + $pr_number + " ë¬¸ì„œ ë™ê¸°í™” ë¶„ì„\n\n## ë³€ê²½ëœ íŒŒì¼\n" + $files + "\n\n## ë³€ê²½ ë‚´ìš©\n```diff\n" + $diff + "\n```\n\n## ë¶„ì„ ìš”ì²­\në‹¤ìŒ í•­ëª©ì„ ë¶„ì„í•˜ê³  ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”:\n\n1. **API ë³€ê²½**: ìƒˆ ì—”ë“œí¬ì¸íŠ¸, ìŠ¤í‚¤ë§ˆ ë³€ê²½, ì¸ì¦ ë³€ê²½\n2. **íƒ€ì… ë³€ê²½**: ìƒˆ íƒ€ì…, ê¸°ì¡´ íƒ€ì… ìˆ˜ì •, Breaking changes\n3. **ì„¤ì • ë³€ê²½**: í™˜ê²½ ë³€ìˆ˜, ì„¤ì • ì˜µì…˜\n\n## ì¶œë ¥ í˜•ì‹\n### ğŸ“ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n| ë¬¸ì„œ | ìƒíƒœ | í•„ìš”í•œ ì—…ë°ì´íŠ¸ |\n|------|------|----------------|\n| docs/api/ | âœ…/âš ï¸/â– | ì„¤ëª… |\n| README.md | âœ…/âš ï¸/â– | ì„¤ëª… |\n| CLAUDE.md | âœ…/âš ï¸/â– | ì„¤ëª… |\n| .env.example | âœ…/âš ï¸/â– | ì„¤ëª… |\n\n### ìƒì„¸ ì•ˆë‚´\n(ì—…ë°ì´íŠ¸ í•„ìš”í•œ í•­ëª©ì— ëŒ€í•œ êµ¬ì²´ì  ê°€ì´ë“œ)\n\n---\nğŸ¤– *OpenAI Documentation Check*")
                }],
                temperature: 0.3,
                max_tokens: 1500
              }')")

          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨"')
          echo "$ANALYSIS" > /tmp/doc-analysis.md

      - name: Check Stale Documentation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### ğŸ“… ë¬¸ì„œ ìµœì‹ ì„± ê²€ì‚¬" >> /tmp/doc-analysis.md
          echo "" >> /tmp/doc-analysis.md

          # docs/ ë””ë ‰í† ë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ -d "${{ inputs.docs-path }}" ]; then
            STALE_DOCS=""

            for doc in $(find ${{ inputs.docs-path }} -name "*.md" -type f 2>/dev/null); do
              DOC_DATE=$(git log -1 --format="%ct" -- "$doc" 2>/dev/null || echo "0")
              CURRENT_DATE=$(date +%s)
              DAYS_OLD=$(( (CURRENT_DATE - DOC_DATE) / 86400 ))

              if [ "$DAYS_OLD" -gt ${{ inputs.stale-days }} ]; then
                STALE_DOCS="$STALE_DOCS\n- âš ï¸ \`$doc\` - ${DAYS_OLD}ì¼ ì „ ìˆ˜ì •"
              fi
            done

            if [ -n "$STALE_DOCS" ]; then
              echo "ë‹¤ìŒ ë¬¸ì„œë“¤ì´ ${{ inputs.stale-days }}ì¼ ì´ìƒ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:" >> /tmp/doc-analysis.md
              echo -e "$STALE_DOCS" >> /tmp/doc-analysis.md
            else
              echo "âœ… ëª¨ë“  ë¬¸ì„œê°€ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤." >> /tmp/doc-analysis.md
            fi
          else
            echo "â„¹ï¸ ${{ inputs.docs-path }}/ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤." >> /tmp/doc-analysis.md
          fi

      - name: Post Analysis Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/doc-analysis.md ] && [ -s /tmp/doc-analysis.md ]; then
            gh pr comment ${{ inputs.pr-number }} --body-file /tmp/doc-analysis.md
          fi

      - name: Add Documentation Label
        if: inputs.add-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOC_CHANGES=$(echo "${{ steps.changed-files.outputs.files }}" | grep -E '^${{ inputs.docs-path }}/|README|\.md$' || true)

          if [ -n "$DOC_CHANGES" ]; then
            gh pr edit ${{ inputs.pr-number }} --add-label "documentation"
          fi
