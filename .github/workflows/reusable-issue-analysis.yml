# =============================================================================
# Reusable Issue Analysis Workflow (OpenAI)
# ì´ìŠˆê°€ í• ë‹¹ë˜ë©´ ê´€ë ¨ ì½”ë“œì™€ ìœ ì‚¬ ì´ìŠˆë¥¼ ë¶„ì„í•˜ì—¬ ì½”ë©˜íŠ¸ë¡œ ì œê³µí•©ë‹ˆë‹¤.
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     analyze:
#       uses: org-workflows/workflows/.github/workflows/reusable-issue-analysis.yml@v1
#       with:
#         issue-number: ${{ github.event.issue.number }}
#         issue-title: ${{ github.event.issue.title }}
#         issue-body: ${{ github.event.issue.body }}
#         assignee: ${{ github.event.assignee.login }}
#       secrets:
#         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#
# =============================================================================

name: Reusable Issue Analysis

on:
  workflow_call:
    inputs:
      issue-number:
        description: 'Issue number to analyze'
        required: true
        type: number
      issue-title:
        description: 'Issue title'
        required: true
        type: string
      issue-body:
        description: 'Issue body'
        required: false
        type: string
        default: ''
      assignee:
        description: 'Issue assignee login'
        required: false
        type: string
        default: ''
      model:
        description: 'OpenAI model to use'
        required: false
        type: string
        default: 'gpt-4o-mini'
      search-extensions:
        description: 'File extensions to search (comma-separated)'
        required: false
        type: string
        default: 'ts,js,tsx,jsx,py'
      max-related-files:
        description: 'Maximum related files to show'
        required: false
        type: number
        default: 10
      max-similar-issues:
        description: 'Maximum similar issues to show'
        required: false
        type: number
        default: 5
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key'
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Search Related Files
        id: search
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="${{ inputs.issue-title }}"
          ISSUE_BODY="${{ inputs.issue-body }}"

          # í‚¤ì›Œë“œ ì¶”ì¶œ (ì œëª©ì—ì„œ ì£¼ìš” ë‹¨ì–´)
          KEYWORDS=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | grep -oE '[a-z]{3,}' | head -5 | tr '\n' ' ')

          # í™•ì¥ì ëª©ë¡ ìƒì„±
          EXTENSIONS="${{ inputs.search-extensions }}"
          INCLUDE_PATTERN=""
          for ext in $(echo "$EXTENSIONS" | tr ',' ' '); do
            INCLUDE_PATTERN="$INCLUDE_PATTERN --include=\"*.$ext\""
          done

          # ê´€ë ¨ íŒŒì¼ ê²€ìƒ‰
          RELATED_FILES=""
          for keyword in $KEYWORDS; do
            FILES=$(eval "grep -rl \"$keyword\" $INCLUDE_PATTERN . 2>/dev/null" | head -3)
            RELATED_FILES="$RELATED_FILES $FILES"
          done
          RELATED_FILES=$(echo "$RELATED_FILES" | tr ' ' '\n' | sort -u | head -${{ inputs.max-related-files }} | tr '\n' ',')

          # ìœ ì‚¬ ì´ìŠˆ ê²€ìƒ‰
          SIMILAR_ISSUES=$(gh issue list --state all --limit ${{ inputs.max-similar-issues }} --json number,title,state --jq '.[] | "#\(.number) [\(.state)] \(.title)"' 2>/dev/null | head -${{ inputs.max-similar-issues }})

          # ì¶œë ¥ ì €ì¥
          echo "keywords=$KEYWORDS" >> $GITHUB_OUTPUT
          echo "files=$RELATED_FILES" >> $GITHUB_OUTPUT
          {
            echo "similar_issues<<EOF"
            echo "$SIMILAR_ISSUES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Analyze with OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PROMPT=$(cat <<'PROMPT_EOF'
          ë‹¹ì‹ ì€ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ì´ìŠˆ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

          ## ì´ìŠˆ ì •ë³´
          - ë²ˆí˜¸: #${{ inputs.issue-number }}
          - ì œëª©: ${{ inputs.issue-title }}
          - ë‹´ë‹¹ì: ${{ inputs.assignee }}
          - ë‚´ìš©: ${{ inputs.issue-body }}

          ## ê²€ìƒ‰ëœ ì •ë³´
          - ê´€ë ¨ í‚¤ì›Œë“œ: ${{ steps.search.outputs.keywords }}
          - ê´€ë ¨ íŒŒì¼: ${{ steps.search.outputs.files }}
          - ìœ ì‚¬ ì´ìŠˆ:
          ${{ steps.search.outputs.similar_issues }}

          ## ìš”ì²­
          ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:

          ### ğŸ“‚ ê´€ë ¨ íŒŒì¼
          (ê´€ë ¨ íŒŒì¼ ëª©ë¡ê³¼ ê° íŒŒì¼ì˜ ê´€ë ¨ì„± ì„¤ëª…)

          ### ğŸ”— ìœ ì‚¬ ì´ìŠˆ/PR
          (ì°¸ê³ í•  ë§Œí•œ ìœ ì‚¬ ì´ìŠˆ ë˜ëŠ” PR)

          ### âœ… ì‘ì—… ì‹œì‘ ì „ í™•ì¸ì‚¬í•­
          (ë‹´ë‹¹ìê°€ ì‘ì—… ì „ í™•ì¸í•´ì•¼ í•  ì‚¬í•­)

          ### ğŸ’¡ ì œì•ˆ ì ‘ê·¼ ë°©ì‹
          (ê¶Œì¥í•˜ëŠ” í•´ê²° ë°©í–¥ê³¼ êµ¬í˜„ íŒíŠ¸)

          ---
          ğŸ¤– *OpenAI ${{ inputs.model }}ë¡œ ë¶„ì„ë¨*
          PROMPT_EOF
          )

          # OpenAI API í˜¸ì¶œ
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg model "${{ inputs.model }}" \
              '{
                model: $model,
                messages: [{role: "user", content: $prompt}],
                temperature: 0.7,
                max_tokens: 1500
              }')")

          # ì‘ë‹µ ì¶”ì¶œ
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ë¶„ì„ ì‹¤íŒ¨"')

          # íŒŒì¼ì— ì €ì¥ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          echo "$ANALYSIS" > /tmp/analysis.md

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/analysis.md ] && [ -s /tmp/analysis.md ]; then
            gh issue comment ${{ inputs.issue-number }} --body-file /tmp/analysis.md
          else
            gh issue comment ${{ inputs.issue-number }} --body "âš ï¸ ì´ìŠˆ ë¶„ì„ì„ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
          fi
