# =============================================================================
# Reusable Issue Triage Workflow
# ìƒˆë¡œìš´ ì´ìŠˆ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³  ë¼ë²¨ì„ ë¶€ì°©í•©ë‹ˆë‹¤.
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     triage:
#       uses: org-workflows/workflows/.github/workflows/reusable-issue-triage.yml@v1
#       secrets:
#         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#         SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#
# =============================================================================

name: ì´ìŠˆ ìë™ ë¶„ë¥˜

on:
  workflow_call:
    inputs:
      issue-number:
        description: 'Issue number to triage'
        required: true
        type: number
      issue-title:
        description: 'Issue title'
        required: true
        type: string
      issue-body:
        description: 'Issue body'
        required: false
        type: string
        default: ''
      issue-url:
        description: 'Issue HTML URL'
        required: true
        type: string
      notify-slack:
        description: 'Send Slack notification'
        required: false
        type: boolean
        default: false
      labels-type:
        description: 'Type labels (comma-separated)'
        required: false
        type: string
        default: 'bug,feature,docs,question'
      labels-priority:
        description: 'Priority labels (comma-separated)'
        required: false
        type: string
        default: 'P0-Critical,P1-High,P2-Medium,P3-Low'
      labels-size:
        description: 'Size labels (comma-separated)'
        required: false
        type: string
        default: 'XS,S,M,L,XL'
      labels-component:
        description: 'Component labels (comma-separated)'
        required: false
        type: string
        default: 'backend,frontend,infra,docs'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true
      SLACK_WEBHOOK:
        description: 'Slack webhook URL'
        required: false

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Analyze and Label Issue
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(gh issue edit *),Write"
          prompt: |
            ì´ìŠˆ #${{ inputs.issue-number }} ë¶„ì„

            ì œëª©: ${{ inputs.issue-title }}
            ë‚´ìš©: ${{ inputs.issue-body }}

            ## ì‘ì—…
            1. ìœ í˜• ë¶„ë¥˜: ${{ inputs.labels-type }} ì¤‘ í•˜ë‚˜
            2. ìš°ì„ ìˆœìœ„: ${{ inputs.labels-priority }} ì¤‘ í•˜ë‚˜
            3. ì‘ì—…ëŸ‰: ${{ inputs.labels-size }} ì¤‘ í•˜ë‚˜
            4. ì»´í¬ë„ŒíŠ¸: ${{ inputs.labels-component }} ì¤‘ í•˜ë‚˜

            ## íŒë‹¨ ê¸°ì¤€
            - P0-Critical: ì„œë¹„ìŠ¤ ì¥ì• , ë°ì´í„° ì†ì‹¤, ë³´ì•ˆ ì·¨ì•½ì 
            - P1-High: ì£¼ìš” ê¸°ëŠ¥ ì˜¤ë¥˜, ë§ì€ ì‚¬ìš©ì ì˜í–¥
            - P2-Medium: ì¼ë°˜ ë²„ê·¸, ê°œì„  í•„ìš”
            - P3-Low: ì‚¬ì†Œí•œ ì´ìŠˆ, ì œì•ˆ

            ## ì‹¤í–‰
            1. ë¶„ì„ì´ ëë‚˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¼ë²¨ì„ ì¶”ê°€í•˜ì„¸ìš”:
               gh issue edit ${{ inputs.issue-number }} --add-label "<ìœ í˜•>,<ìš°ì„ ìˆœìœ„>,<ì‘ì—…ëŸ‰>,<ì»´í¬ë„ŒíŠ¸>"

            2. ë¶„ì„ ê²°ê³¼ë¥¼ /tmp/analysis.md íŒŒì¼ì— ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”.
               (ë¶„ë¥˜ ê²°ê³¼, íŒë‹¨ ê·¼ê±°, ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ í¬í•¨)

      - name: Post Analysis Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/analysis.md ]; then
            gh issue comment ${{ inputs.issue-number }} --body-file /tmp/analysis.md
          fi

      - name: Notify Slack
        if: success() && inputs.notify-slack && vars.SLACK_ENABLED == 'true'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ğŸ†• ìƒˆ ì´ìŠˆ ë¶„ë¥˜ ì™„ë£Œ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ì´ìŠˆ #${{ inputs.issue-number }}: ${{ inputs.issue-title }}\n<${{ inputs.issue-url }}|ì´ìŠˆ ë³´ê¸°>"
                  }
                }
              ]
            }'
