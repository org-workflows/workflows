# =============================================================================
# Reusable Migration Safety Check Workflow
# DB ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ë³€ê²½ ì‹œ ì•ˆì „ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     migration:
#       uses: org-workflows/workflows/.github/workflows/reusable-migration-check.yml@v1
#       with:
#         pr-number: ${{ github.event.number }}
#       secrets:
#         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#
# =============================================================================

name: ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦

on:
  workflow_call:
    inputs:
      pr-number:
        description: 'Pull request number'
        required: true
        type: number
      migration-paths:
        description: 'Migration paths to check (comma-separated)'
        required: false
        type: string
        default: 'migrations,prisma/migrations'
      generate-rollback:
        description: 'Generate rollback script'
        required: false
        type: boolean
        default: true
      commit-rollback:
        description: 'Commit rollback script to PR'
        required: false
        type: boolean
        default: true
      dba-team:
        description: 'Team to mention for high/critical migrations'
        required: false
        type: string
        default: 'devops-team'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true

jobs:
  analyze:
    name: Analyze Migration
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Get Changed Migration Files
        id: migration-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PATHS="${{ inputs.migration-paths }}"
          PATTERN=$(echo "$PATHS" | tr ',' '|')
          FILES=$(gh pr diff ${{ inputs.pr-number }} --name-only | grep -E "($PATTERN)" || echo "")
          echo "files=${FILES}" >> $GITHUB_OUTPUT

          if [ -n "$FILES" ]; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Migration Safety
        if: steps.migration-files.outputs.has_migrations == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr comment *),Write"
          prompt: |
            PR #${{ inputs.pr-number }} ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆì „ì„± ë¶„ì„

            ë³€ê²½ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼: ${{ steps.migration-files.outputs.files }}

            ## ë¶„ì„ í•­ëª©
            1. ì˜í–¥ë°›ëŠ” í…Œì´ë¸”/ì»¬ëŸ¼ ì‹ë³„
            2. ì˜ˆìƒ ë½(Lock) ì‹œê°„
            3. ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥ì„±
            4. ë‹¤ìš´íƒ€ìž„ í•„ìš” ì—¬ë¶€
            5. ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì—¬ë¶€

            ## ìœ„í—˜ë„ í‰ê°€ ê¸°ì¤€
            - ðŸŸ¢ Low: ë‹¨ìˆœ ì¶”ê°€ (ìƒˆ í…Œì´ë¸”, ìƒˆ nullable ì»¬ëŸ¼, ì¸ë±ìŠ¤)
            - ðŸŸ¡ Medium: ì»¬ëŸ¼ ìˆ˜ì •, ì œì•½ì¡°ê±´ ì¶”ê°€
            - ðŸŸ  High: ëŒ€ëŸ‰ ë°ì´í„° ë³€ê²½, ì»¬ëŸ¼ íƒ€ìž… ë³€ê²½
            - ðŸ”´ Critical: í…Œì´ë¸” ì‚­ì œ, ë°ì´í„° ì‚­ì œ, ìŠ¤í‚¤ë§ˆ ëŒ€í­ ë³€ê²½

            ## ì¶œë ¥
            1. ë¶„ì„ ê²°ê³¼ë¥¼ /tmp/migration-analysis.md íŒŒì¼ì— ìž‘ì„±
            2. ìœ„í—˜ë„ì— ë”°ë¥¸ ë¼ë²¨ ì¶”ê°€:
               gh pr edit ${{ inputs.pr-number }} --add-label "migration,needs-dba-review"
            3. High/Criticalì¸ ê²½ìš° @${{ inputs.dba-team }} ë©˜ì…˜ í¬í•¨

      - name: Post Analysis Comment
        if: steps.migration-files.outputs.has_migrations == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/migration-analysis.md ]; then
            gh pr comment ${{ inputs.pr-number }} --body-file /tmp/migration-analysis.md
          fi

      - name: Create Rollback Directory
        if: inputs.generate-rollback && steps.migration-files.outputs.has_migrations == 'true'
        run: mkdir -p migrations/rollbacks

      - name: Generate Rollback Script
        if: inputs.generate-rollback && steps.migration-files.outputs.has_migrations == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Write,Bash(gh pr comment *)"
          prompt: |
            PR #${{ inputs.pr-number }}ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ëŒ€í•œ ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±

            ## ìš”êµ¬ì‚¬í•­
            1. ê° ë§ˆì´ê·¸ë ˆì´ì…˜ì— ëŒ€ì‘í•˜ëŠ” ë¡¤ë°± SQL ìž‘ì„±
            2. íŒŒì¼ëª…: migrations/rollbacks/rollback_pr${{ inputs.pr-number }}_$(date +%Y%m%d).sql
            3. ì‹¤í–‰ ìˆœì„œ ì£¼ì„ í¬í•¨
            4. ë°ì´í„° ë°±ì—… ëª…ë ¹ì–´ í¬í•¨ (í•„ìš”ì‹œ)

            ìƒì„±ëœ ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ë¥¼ PR ì½”ë©˜íŠ¸ì—ë„ ì²¨ë¶€

      - name: Commit Rollback Script
        if: inputs.commit-rollback && inputs.generate-rollback && steps.migration-files.outputs.has_migrations == 'true'
        run: |
          if [ -n "$(ls -A migrations/rollbacks/ 2>/dev/null)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add migrations/rollbacks/
            git commit -m "chore: add rollback script for PR #${{ inputs.pr-number }}" || echo "No changes to commit"
            git push || echo "Nothing to push"
          fi

      - name: Skip Message
        if: steps.migration-files.outputs.has_migrations == 'false'
        run: echo "No migration files changed in this PR"
