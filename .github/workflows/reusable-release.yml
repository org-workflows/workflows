# =============================================================================
# Reusable Release Workflow
# ë²„ì „ íƒœê·¸ í‘¸ì‹œ ì‹œ ìë™ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# =============================================================================
#
# ì‚¬ìš©ë²•:
#   jobs:
#     release:
#       uses: org-workflows/workflows/.github/workflows/reusable-release.yml@v1
#       with:
#         tag-name: ${{ github.ref_name }}
#       secrets:
#         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#         SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
#
# =============================================================================

name: ë¦´ë¦¬ì¦ˆ ìë™í™”

on:
  workflow_call:
    inputs:
      tag-name:
        description: 'Tag name for the release'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true
      generate-changelog:
        description: 'Generate changelog using AI'
        required: false
        type: boolean
        default: true
      commit-changelog:
        description: 'Commit changelog to repository'
        required: false
        type: boolean
        default: true
      build-command:
        description: 'Build command to run'
        required: false
        type: string
        default: 'npm ci && npm run build'
      build-artifact-path:
        description: 'Path to build artifacts'
        required: false
        type: string
        default: 'dist/'
      notify-slack:
        description: 'Send Slack notification'
        required: false
        type: boolean
        default: false
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true
      SLACK_WEBHOOK:
        description: 'Slack webhook URL'
        required: false

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (changelog ìƒì„±ìš©)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Get Previous Tag
        id: prev-tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"

      - name: Generate Changelog
        if: inputs.generate-changelog
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(git log *),Write"
          prompt: |
            ë¦´ë¦¬ì¦ˆ ${{ inputs.tag-name }} Changelog ìƒì„±

            ì´ì „ íƒœê·¸: ${{ steps.prev-tag.outputs.tag || '(ì²« ë¦´ë¦¬ì¦ˆ)' }}

            ## ì‘ì—…
            1. ì´ì „ íƒœê·¸ ì´í›„ ëª¨ë“  ì»¤ë°‹ ë¶„ì„
               - git log ${{ steps.prev-tag.outputs.tag }}..HEAD --oneline (ì´ì „ íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°)
               - git log --oneline (ì²« ë¦´ë¦¬ì¦ˆì¸ ê²½ìš°)

            2. Conventional Commits ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜:
               - âœ¨ Features (feat:)
               - ğŸ› Bug Fixes (fix:)
               - ğŸ“ Documentation (docs:)
               - â™»ï¸ Refactoring (refactor:)
               - âš¡ Performance (perf:)
               - ğŸ”§ Chores (chore:)
               - ğŸ’¥ Breaking Changes (BREAKING CHANGE ë˜ëŠ” !)

            3. CHANGELOG.md íŒŒì¼ ì—…ë°ì´íŠ¸
               - ê¸°ì¡´ ë‚´ìš© ìœ„ì— ìƒˆ ë²„ì „ ì¶”ê°€
               - ë‚ ì§œ í¬í•¨

            4. RELEASE_NOTES.md íŒŒì¼ ìƒì„±
               - ì‚¬ìš©ì ì¹œí™”ì  ì–¸ì–´ë¡œ ì‘ì„±
               - ì£¼ìš” ë³€ê²½ì‚¬í•­ 3-5ê°œ í•˜ì´ë¼ì´íŠ¸
               - Breaking Changes ê°•ì¡°
               - ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ (í•„ìš”ì‹œ)

      - name: Commit Changelog
        if: inputs.commit-changelog && inputs.generate-changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CHANGELOG.md
            git commit -m "docs: update changelog for ${{ inputs.tag-name }}" || echo "No changes to commit"
            git push origin HEAD:main || echo "Could not push to main"
          fi

      - name: Build Release Assets
        run: |
          ${{ inputs.build-command }}

          # ë¹Œë“œ ê²°ê³¼ë¬¼ ì••ì¶•
          if [ -d "${{ inputs.build-artifact-path }}" ]; then
            tar -czf release-${{ inputs.tag-name }}.tar.gz ${{ inputs.build-artifact-path }}
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ í™•ì¸
          if [ -f RELEASE_NOTES.md ]; then
            NOTES_FILE="RELEASE_NOTES.md"
          else
            echo "No release notes generated, using auto-generated notes"
            NOTES_FILE=""
          fi

          # Draft ì˜µì…˜
          DRAFT_FLAG=""
          if [ "${{ inputs.draft }}" == "true" ]; then
            DRAFT_FLAG="--draft"
          fi

          # GitHub Release ìƒì„±
          if [ -f "release-${{ inputs.tag-name }}.tar.gz" ]; then
            if [ -n "$NOTES_FILE" ]; then
              gh release create ${{ inputs.tag-name }} \
                --title "${{ inputs.tag-name }}" \
                --notes-file "$NOTES_FILE" \
                $DRAFT_FLAG \
                release-${{ inputs.tag-name }}.tar.gz
            else
              gh release create ${{ inputs.tag-name }} \
                --title "${{ inputs.tag-name }}" \
                --generate-notes \
                $DRAFT_FLAG \
                release-${{ inputs.tag-name }}.tar.gz
            fi
          else
            if [ -n "$NOTES_FILE" ]; then
              gh release create ${{ inputs.tag-name }} \
                --title "${{ inputs.tag-name }}" \
                --notes-file "$NOTES_FILE" \
                $DRAFT_FLAG
            else
              gh release create ${{ inputs.tag-name }} \
                --title "${{ inputs.tag-name }}" \
                --generate-notes \
                $DRAFT_FLAG
            fi
          fi

          echo "ğŸ“¦ Release created: ${{ inputs.tag-name }}"

      - name: Notify Slack
        if: inputs.notify-slack && vars.SLACK_ENABLED == 'true'
        run: |
          DRAFT_TEXT=""
          if [ "${{ inputs.draft }}" == "true" ]; then
            DRAFT_TEXT=" ì´ˆì•ˆ"
          fi

          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ğŸ“¦ ìƒˆ ë¦´ë¦¬ì¦ˆ'"$DRAFT_TEXT"' ìƒì„±ë¨",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë¦´ë¦¬ì¦ˆ ${{ inputs.tag-name }}'"$DRAFT_TEXT"' ìƒì„±* ğŸ“¦\n<${{ github.server_url }}/${{ github.repository }}/releases|ë¦´ë¦¬ì¦ˆ í™•ì¸>"
                  }
                }
              ]
            }'
