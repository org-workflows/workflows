# =============================================================================
# Reusable Security Scan Pipeline
# Îã§Î•∏ Ï†ÄÏû•ÏÜåÏóêÏÑú Ìò∏Ï∂úÌïòÏó¨ ÏÇ¨Ïö©ÌïòÎäî Î≥¥Ïïà Ïä§Ï∫î ÌååÏù¥ÌîÑÎùºÏù∏
# =============================================================================
#
# ÏÇ¨Ïö©Î≤ï:
#   jobs:
#     security:
#       uses: org-workflows/workflows/.github/workflows/reusable-security.yml@v1
#       secrets: inherit
#
# =============================================================================

name: Î≥¥Ïïà Í≤ÄÏÇ¨

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js Î≤ÑÏ†Ñ'
        type: string
        required: false
        default: '20'

      working-directory:
        description: 'ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨'
        type: string
        required: false
        default: '.'

      run-npm-audit:
        description: 'npm audit Ïã§Ìñâ Ïó¨Î∂Ä'
        type: boolean
        required: false
        default: true

      run-secret-scan:
        description: 'ÏãúÌÅ¨Î¶ø Ïä§Ï∫î Ïã§Ìñâ Ïó¨Î∂Ä'
        type: boolean
        required: false
        default: true

      fail-on-high:
        description: 'high Ïù¥ÏÉÅ Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨ Ïãú Ïã§Ìå®'
        type: boolean
        required: false
        default: true

      notify-slack:
        description: 'Slack ÏïåÎ¶º Ïó¨Î∂Ä'
        type: boolean
        required: false
        default: true

    secrets:
      SLACK_WEBHOOK:
        description: 'Slack ÏõπÌõÖ URL'
        required: false

    outputs:
      vulnerabilities-found:
        description: 'Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨ Ïó¨Î∂Ä'
        value: ${{ jobs.audit.outputs.vulnerabilities-found }}

      critical-count:
        description: 'Critical Ï∑®ÏïΩÏ†ê Ïàò'
        value: ${{ jobs.audit.outputs.critical }}

      high-count:
        description: 'High Ï∑®ÏïΩÏ†ê Ïàò'
        value: ${{ jobs.audit.outputs.high }}

jobs:
  audit:
    name: Dependency Audit
    if: ${{ inputs.run-npm-audit }}
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.found }}
      critical: ${{ steps.audit.outputs.critical }}
      high: ${{ steps.audit.outputs.high }}

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install Dependencies
        run: npm ci
        continue-on-error: true

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit-result.json 2>&1 || true

          if [ -f audit-result.json ]; then
            CRITICAL=$(cat audit-result.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat audit-result.json | jq '.metadata.vulnerabilities.high // 0')
            MODERATE=$(cat audit-result.json | jq '.metadata.vulnerabilities.moderate // 0')
            LOW=$(cat audit-result.json | jq '.metadata.vulnerabilities.low // 0')
            TOTAL=$((CRITICAL + HIGH + MODERATE + LOW))

            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT

            if [ "$TOTAL" -gt 0 ]; then
              echo "found=true" >> $GITHUB_OUTPUT
            else
              echo "found=false" >> $GITHUB_OUTPUT
            fi

            echo "## üìä Ï∑®ÏïΩÏ†ê ÏöîÏïΩ" >> $GITHUB_STEP_SUMMARY
            echo "| Ïã¨Í∞ÅÎèÑ | Í∞úÏàò |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
          fi

      - name: Check Threshold
        if: ${{ inputs.fail-on-high }}
        run: |
          CRITICAL=${{ steps.audit.outputs.critical }}
          HIGH=${{ steps.audit.outputs.high }}

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high vulnerabilities"
            exit 1
          fi

      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: ${{ inputs.working-directory }}/audit-result.json
          retention-days: 30
          if-no-files-found: ignore

  secret-scan:
    name: Secret Scan
    if: ${{ inputs.run-secret-scan }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for Secrets
        id: secret-scan
        run: |
          echo "üîç Scanning for secrets..."

          # Í∞ÑÎã®Ìïú Ìå®ÌÑ¥ Ïä§Ï∫î
          PATTERNS=(
            "AKIA[0-9A-Z]{16}"                    # AWS Access Key
            "sk-[a-zA-Z0-9]{48}"                   # OpenAI API Key
            "ghp_[a-zA-Z0-9]{36}"                  # GitHub PAT
            "xox[baprs]-[0-9a-zA-Z-]+"             # Slack Token
            "-----BEGIN.*PRIVATE KEY-----"         # Private Key
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.js" --include="*.ts" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.env*" . 2>/dev/null | grep -v node_modules | grep -v ".git"; then
              echo "::warning::Potential secret found matching pattern: $pattern"
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Potential secrets detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on Secrets
        if: steps.secret-scan.outputs.found == 'true'
        run: |
          echo "::error::Potential secrets found in codebase"
          exit 1

  notify:
    name: Notify Results
    needs: [audit, secret-scan]
    if: always() && inputs.notify-slack
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          AUDIT_STATUS="${{ needs.audit.result }}"
          SECRET_STATUS="${{ needs.secret-scan.result }}"
          CRITICAL="${{ needs.audit.outputs.critical || 0 }}"
          HIGH="${{ needs.audit.outputs.high || 0 }}"

          if [ "$AUDIT_STATUS" = "success" ] && [ "$SECRET_STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="ÌÜµÍ≥º"
          else
            EMOJI="üî¥"
            STATUS="Ï£ºÏùò ÌïÑÏöî"
          fi

          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$EMOJI Î≥¥Ïïà Ïä§Ï∫î $STATUS\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*$EMOJI Î≥¥Ïïà Ïä§Ï∫î Í≤∞Í≥º: $STATUS*\n‚Ä¢ Ï†ÄÏû•ÏÜå: \`${{ github.repository }}\`\n‚Ä¢ Critical: $CRITICAL, High: $HIGH\"
                  }
                }
              ]
            }"
