# =============================================================================
# Issue Triage Workflow
# ìƒˆë¡œìš´ ì´ìŠˆ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³  ë¼ë²¨ì„ ë¶€ì°©í•©ë‹ˆë‹¤.
# =============================================================================
#
# í•„ìˆ˜ ì„¤ì •:
#   - secrets.ANTHROPIC_API_KEY: Anthropic API í‚¤
#
# ì„ íƒ ì„¤ì •:
#   - secrets.SLACK_WEBHOOK: Slack ì›¹í›… URL (ì•Œë¦¼ìš©)
#
# =============================================================================

name: Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Analyze and Label Issue
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(gh issue edit *),Write"
          prompt: |
            ì´ìŠˆ #${{ github.event.issue.number }} ë¶„ì„

            ì œëª©: ${{ github.event.issue.title }}
            ë‚´ìš©: ${{ github.event.issue.body }}

            ## ì‘ì—…
            1. ìœ í˜• ë¶„ë¥˜: bug/feature/docs/question ì¤‘ í•˜ë‚˜
            2. ìš°ì„ ìˆœìœ„: P0-Critical/P1-High/P2-Medium/P3-Low ì¤‘ í•˜ë‚˜
            3. ì‘ì—…ëŸ‰: XS/S/M/L/XL ì¤‘ í•˜ë‚˜
            4. ì»´í¬ë„ŒíŠ¸: backend/frontend/infra/docs ì¤‘ í•˜ë‚˜

            ## íŒë‹¨ ê¸°ì¤€
            - P0-Critical: ì„œë¹„ìŠ¤ ì¥ì• , ë°ì´í„° ì†ì‹¤, ë³´ì•ˆ ì·¨ì•½ì 
            - P1-High: ì£¼ìš” ê¸°ëŠ¥ ì˜¤ë¥˜, ë§ì€ ì‚¬ìš©ì ì˜í–¥
            - P2-Medium: ì¼ë°˜ ë²„ê·¸, ê°œì„  í•„ìš”
            - P3-Low: ì‚¬ì†Œí•œ ì´ìŠˆ, ì œì•ˆ

            ## ì‹¤í–‰
            1. ë¶„ì„ì´ ëë‚˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¼ë²¨ì„ ì¶”ê°€í•˜ì„¸ìš”:
               gh issue edit ${{ github.event.issue.number }} --add-label "<ìœ í˜•>,<ìš°ì„ ìˆœìœ„>,<ì‘ì—…ëŸ‰>,<ì»´í¬ë„ŒíŠ¸>"

            2. ë¶„ì„ ê²°ê³¼ë¥¼ /tmp/analysis.md íŒŒì¼ì— ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”.
               (ë¶„ë¥˜ ê²°ê³¼, íŒë‹¨ ê·¼ê±°, ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­ í¬í•¨)

      - name: Post Analysis Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/analysis.md ]; then
            gh issue comment ${{ github.event.issue.number }} --body-file /tmp/analysis.md
          fi

      - name: Notify Slack
        if: success() && vars.SLACK_ENABLED == 'true'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ğŸ†• ìƒˆ ì´ìŠˆ ë¶„ë¥˜ ì™„ë£Œ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ì´ìŠˆ #${{ github.event.issue.number }}: ${{ github.event.issue.title }}\n<${{ github.event.issue.html_url }}|ì´ìŠˆ ë³´ê¸°>"
                  }
                }
              ]
            }'
