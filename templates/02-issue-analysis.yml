# =============================================================================
# Issue Analysis Workflow (OpenAI)
# ì´ìŠˆê°€ í• ë‹¹ë˜ë©´ ê´€ë ¨ ì½”ë“œì™€ ìœ ì‚¬ ì´ìŠˆë¥¼ ë¶„ì„í•˜ì—¬ ì½”ë©˜íŠ¸ë¡œ ì œê³µí•©ë‹ˆë‹¤.
# =============================================================================
#
# í•„ìˆ˜ ì„¤ì •:
#   - secrets.OPENAI_API_KEY: OpenAI API í‚¤
#
# ì‚¬ìš© ëª¨ë¸: GPT-4o-mini (ë¹„ìš© íš¨ìœ¨ì )
#
# =============================================================================

name: Issue Analysis

on:
  issues:
    types: [assigned]

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Search Related Files
        id: search
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          # í‚¤ì›Œë“œ ì¶”ì¶œ (ì œëª©ì—ì„œ ì£¼ìš” ë‹¨ì–´)
          KEYWORDS=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | grep -oE '[a-z]{3,}' | head -5 | tr '\n' ' ')

          # ê´€ë ¨ íŒŒì¼ ê²€ìƒ‰
          RELATED_FILES=""
          for keyword in $KEYWORDS; do
            FILES=$(grep -rl "$keyword" --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" --include="*.py" . 2>/dev/null | head -3)
            RELATED_FILES="$RELATED_FILES $FILES"
          done
          RELATED_FILES=$(echo "$RELATED_FILES" | tr ' ' '\n' | sort -u | head -10 | tr '\n' ',')

          # ìœ ì‚¬ ì´ìŠˆ ê²€ìƒ‰
          SIMILAR_ISSUES=$(gh issue list --state all --limit 5 --json number,title,state --jq '.[] | "#\(.number) [\(.state)] \(.title)"' 2>/dev/null | head -5)

          # ì¶œë ¥ ì €ì¥
          echo "keywords=$KEYWORDS" >> $GITHUB_OUTPUT
          echo "files=$RELATED_FILES" >> $GITHUB_OUTPUT
          {
            echo "similar_issues<<EOF"
            echo "$SIMILAR_ISSUES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Analyze with OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PROMPT=$(cat <<'PROMPT_EOF'
          ë‹¹ì‹ ì€ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ì´ìŠˆ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

          ## ì´ìŠˆ ì •ë³´
          - ë²ˆí˜¸: #${{ github.event.issue.number }}
          - ì œëª©: ${{ github.event.issue.title }}
          - ë‹´ë‹¹ì: ${{ github.event.assignee.login }}
          - ë‚´ìš©: ${{ github.event.issue.body }}

          ## ê²€ìƒ‰ëœ ì •ë³´
          - ê´€ë ¨ í‚¤ì›Œë“œ: ${{ steps.search.outputs.keywords }}
          - ê´€ë ¨ íŒŒì¼: ${{ steps.search.outputs.files }}
          - ìœ ì‚¬ ì´ìŠˆ:
          ${{ steps.search.outputs.similar_issues }}

          ## ìš”ì²­
          ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:

          ### ğŸ“‚ ê´€ë ¨ íŒŒì¼
          (ê´€ë ¨ íŒŒì¼ ëª©ë¡ê³¼ ê° íŒŒì¼ì˜ ê´€ë ¨ì„± ì„¤ëª…)

          ### ğŸ”— ìœ ì‚¬ ì´ìŠˆ/PR
          (ì°¸ê³ í•  ë§Œí•œ ìœ ì‚¬ ì´ìŠˆ ë˜ëŠ” PR)

          ### âœ… ì‘ì—… ì‹œì‘ ì „ í™•ì¸ì‚¬í•­
          (ë‹´ë‹¹ìê°€ ì‘ì—… ì „ í™•ì¸í•´ì•¼ í•  ì‚¬í•­)

          ### ğŸ’¡ ì œì•ˆ ì ‘ê·¼ ë°©ì‹
          (ê¶Œì¥í•˜ëŠ” í•´ê²° ë°©í–¥ê³¼ êµ¬í˜„ íŒíŠ¸)

          ---
          ğŸ¤– *OpenAI GPT-4o-minië¡œ ë¶„ì„ë¨*
          PROMPT_EOF
          )

          # OpenAI API í˜¸ì¶œ
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                model: "gpt-4o-mini",
                messages: [{role: "user", content: $prompt}],
                temperature: 0.7,
                max_tokens: 1500
              }')")

          # ì‘ë‹µ ì¶”ì¶œ
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ë¶„ì„ ì‹¤íŒ¨"')

          # íŒŒì¼ì— ì €ì¥ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          echo "$ANALYSIS" > /tmp/analysis.md

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/analysis.md ] && [ -s /tmp/analysis.md ]; then
            gh issue comment ${{ github.event.issue.number }} --body-file /tmp/analysis.md
          else
            gh issue comment ${{ github.event.issue.number }} --body "âš ï¸ ì´ìŠˆ ë¶„ì„ì„ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
          fi
