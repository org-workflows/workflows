# =============================================================================
# Release Workflow
# ë²„ì „ íƒœê·¸ í‘¸ì‹œ ì‹œ ìë™ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# =============================================================================
#
# í•„ìˆ˜ ì„¤ì •:
#   - secrets.ANTHROPIC_API_KEY: Anthropic API í‚¤
#
# ì‚¬ìš©ë²•:
#   git tag v1.0.0
#   git push origin v1.0.0
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (changelog ìƒì„±ìš©)
      
      - name: Setup Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Get Previous Tag
        id: prev-tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"
      
      - name: Generate Changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_TAG: ${{ github.ref_name }}
          PREVIOUS_TAG: ${{ steps.prev-tag.outputs.tag }}
        run: |
          claude -p "
            ë¦´ë¦¬ì¦ˆ ${CURRENT_TAG} Changelog ìƒì„±
            
            ì´ì „ íƒœê·¸: ${PREVIOUS_TAG:-'(ì²« ë¦´ë¦¬ì¦ˆ)'}
            
            ## ì‘ì—…
            1. ì´ì „ íƒœê·¸ ì´í›„ ëª¨ë“  ì»¤ë°‹ ë¶„ì„
               - git log ${PREVIOUS_TAG}..HEAD --oneline (ì´ì „ íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°)
               - git log --oneline (ì²« ë¦´ë¦¬ì¦ˆì¸ ê²½ìš°)
            
            2. Conventional Commits ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜:
               - âœ¨ Features (feat:)
               - ğŸ› Bug Fixes (fix:)
               - ğŸ“ Documentation (docs:)
               - â™»ï¸ Refactoring (refactor:)
               - âš¡ Performance (perf:)
               - ğŸ”§ Chores (chore:)
               - ğŸ’¥ Breaking Changes (BREAKING CHANGE ë˜ëŠ” !)
            
            3. CHANGELOG.md íŒŒì¼ ì—…ë°ì´íŠ¸
               - ê¸°ì¡´ ë‚´ìš© ìœ„ì— ìƒˆ ë²„ì „ ì¶”ê°€
               - ë‚ ì§œ í¬í•¨
            
            4. RELEASE_NOTES.md íŒŒì¼ ìƒì„±
               - ì‚¬ìš©ì ì¹œí™”ì  ì–¸ì–´ë¡œ ì‘ì„±
               - ì£¼ìš” ë³€ê²½ì‚¬í•­ 3-5ê°œ í•˜ì´ë¼ì´íŠ¸
               - Breaking Changes ê°•ì¡°
               - ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ (í•„ìš”ì‹œ)
          "
      
      - name: Commit Changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CHANGELOG.md
            git commit -m "docs: update changelog for ${{ github.ref_name }}" || echo "No changes to commit"
            git push origin HEAD:main || echo "Could not push to main"
          fi
      
      - name: Build Release Assets
        run: |
          npm ci
          npm run build

          # ë¹Œë“œ ê²°ê³¼ë¬¼ ì••ì¶•
          tar -czf release-${{ github.ref_name }}.tar.gz dist/
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ íŒŒì¼ í™•ì¸
          if [ -f RELEASE_NOTES.md ]; then
            NOTES_FILE="RELEASE_NOTES.md"
          else
            echo "No release notes generated, using auto-generated notes"
            NOTES_FILE=""
          fi
          
          # GitHub Release ìƒì„± (Draft ìƒíƒœ)
          if [ -n "$NOTES_FILE" ]; then
            gh release create ${{ github.ref_name }} \
              --title "${{ github.ref_name }}" \
              --notes-file "$NOTES_FILE" \
              --draft \
              release-${{ github.ref_name }}.tar.gz
          else
            gh release create ${{ github.ref_name }} \
              --title "${{ github.ref_name }}" \
              --generate-notes \
              --draft \
              release-${{ github.ref_name }}.tar.gz
          fi
          
          echo "ğŸ“¦ Release draft created: ${{ github.ref_name }}"
      
      - name: Notify Team
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "ğŸ“¦ ìƒˆ ë¦´ë¦¬ì¦ˆ ì´ˆì•ˆ ìƒì„±ë¨",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë¦´ë¦¬ì¦ˆ ${{ github.ref_name }} ì´ˆì•ˆ ìƒì„±* ğŸ“¦\n<${{ github.server_url }}/${{ github.repository }}/releases|ë¦´ë¦¬ì¦ˆ í™•ì¸ ë° ë°œí–‰>"
                  }
                }
              ]
            }'
